
# Apache configuration for Sentinel GRC with security headers
<VirtualHost *:80>
    ServerName sentinelgrc.com
    ServerAlias www.sentinelgrc.com
    
    # Redirect to HTTPS
    Redirect permanent / https://sentinelgrc.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName sentinelgrc.com
    ServerAlias www.sentinelgrc.com
    
    # SSL configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/sentinelgrc.com/cert.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/sentinelgrc.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/sentinelgrc.com/chain.pem
    
    # Modern SSL configuration
    SSLProtocol TLSv1.2 TLSv1.3
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    
    # Security headers
    Header always set "Content-Security-Policy" "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.groq.com https://*.supabase.co wss://*.supabase.co https://cdn.jsdelivr.net; media-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; block-all-mixed-content; upgrade-insecure-requests; report-uri /api/csp-report"
    Header always set "X-Content-Type-Options" "nosniff"
    Header always set "X-Frame-Options" "DENY"
    Header always set "X-XSS-Protection" "1; mode=block"
    Header always set "Referrer-Policy" "strict-origin-when-cross-origin"
    Header always set "Permissions-Policy" "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()"
    Header always set "Strict-Transport-Security" "max-age=31536000; includeSubDomains; preload"
    Header always set "Cache-Control" "no-store, no-cache, must-revalidate, max-age=0"
    Header always set "Pragma" "no-cache"
    Header always set "Expires" "0"

    
    # Rate limiting (requires mod_evasive)
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        50
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    
    # Proxy configuration
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:8501/
    ProxyPassReverse / http://127.0.0.1:8501/
    
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://127.0.0.1:8501/$1" [P,L]
    
    # Block common attack paths
    <LocationMatch "^/(admin|phpmyadmin|wp-admin|wp-login)">
        Require all denied
    </LocationMatch>
    
    # Custom error pages
    ErrorDocument 403 /403.html
    ErrorDocument 404 /404.html
    ErrorDocument 500 /500.html
</VirtualHost>
